# Многоязычная система заказов

## Описание функционала

Реализована система, при которой:

1. **Механик** выбирает язык интерфейса (русский, английский, иврит)
2. **Механик** видит категории и запчасти на выбранном языке
3. **Механик** создает заказ с запчастями на своем языке
4. **Админ** всегда видит заказы на русском языке в админ-панели
5. **Telegram уведомления** администратору приходят на русском языке
6. **Печатные чеки** формируются на русском языке

## Как это работает

### 1. Хранение данных

В базе данных запчасти (`Part`) и категории (`Category`) имеют названия на трех языках:
- `name_ru` - русский
- `name_en` - английский  
- `name_he` - иврит

### 2. Создание заказа механиком

Когда механик создает заказ:
- Выбирает категорию на своем языке (например, "מנוע" на иврите)
- Выбирает запчасти на своем языке (например, "פילטר שמן" на иврите)
- В базе данных сохраняются:
  - `part_id` - ID запчасти для последующего перевода
  - `name` - название на языке механика (для отображения, если перевод недоступен)
  - `quantity` - количество

Формат данных в `selected_parts`:
```json
[
  {
    "part_id": 15,
    "name": "פילטר שמן",
    "quantity": 2
  },
  {
    "part_id": 23,
    "name": "פילטר אוויר",
    "quantity": 1
  }
]
```

### 3. Отображение в админ-панели

При запросе списка заказов через API `/api/orders`:
- Вызывается метод `order.to_dict(lang='ru')`
- Система автоматически:
  1. Находит запчасть по `part_id`
  2. Получает её название на русском: `part.get_name('ru')`
  3. Возвращает переведенные данные

Админ видит в интерфейсе:
```
Категория: Двигатель
Детали:
- Масляный фильтр (x2)
- Воздушный фильтр (x1)
```

### 4. Уведомления и печать

**Telegram уведомление админу:**
- Категория переводится на русский
- Названия запчастей переводятся на русский
- Админ получает понятное уведомление

**Печатный чек:**
- Формируется на русском языке
- Использует те же механизмы перевода

## Изменения в коде

### models.py

**Модель Order:**
```python
def to_dict(self, include_mechanic=False, lang=None):
    # Обработка selected_parts с переводом
    selected_parts_translated = []
    for part in (self.selected_parts or []):
        if isinstance(part, dict):
            part_id = part.get('part_id')
            
            # Если есть part_id, получаем название на нужном языке
            if part_id:
                part_obj = Part.query.get(part_id)
                if part_obj:
                    part_name = part_obj.get_name(lang) if lang else part_obj.get_name('ru')
                    selected_parts_translated.append({
                        'part_id': part_id,
                        'name': part_name,
                        'quantity': quantity
                    })
```

### app.py

**API каталога запчастей:**
```python
@app.route('/api/parts/catalog', methods=['GET'])
def get_parts_catalog():
    # Возвращает запчасти с ID и переведенными названиями
    catalog[category_name].append({
        'id': part.id,
        'name': part.get_name(lang)
    })
```

**API получения заказов:**
```python
@app.route('/api/orders')
def get_orders():
    # Админ всегда получает данные на русском языке
    return jsonify([order.to_dict(lang='ru') for order in orders])
```

**Уведомления:**
```python
def notify_admin_new_order(order):
    # Переводим категорию на русский
    category_obj = Category.query.filter_by(name=order.category).first()
    if category_obj:
        category_name = category_obj.get_name('ru')
    
    # Переводим запчасти на русский
    if part_id:
        part_obj = Part.query.get(part_id)
        name = part_obj.get_name('ru') if part_obj else part.get('name', '')
```

### Шаблоны

**mechanic.html и mechanic/order_form.html:**
- Обработка нового формата каталога с ID
- Сохранение `part_id` при выборе запчасти
- Отправка `part_id` в API вместе с названием

```javascript
// Новый формат selectedParts
selectedParts[partKey] = {
    name: partName,
    quantity: quantity,
    part_id: partId ? parseInt(partId) : null
};

// Отправка на сервер
const partData = {
    name: part.name,
    quantity: part.quantity
};

if (part.part_id) {
    partData.part_id = part.part_id;
}
```

## Обратная совместимость

Система поддерживает:
1. **Старый формат** - запчасти как массив строк
2. **Промежуточный формат** - объекты с `name` и `quantity`
3. **Новый формат** - объекты с `name`, `quantity` и `part_id`

Это обеспечивает работу со старыми заказами без миграции данных.

## Преимущества

✅ Механик работает на удобном ему языке  
✅ Админ всегда видит заказы на русском  
✅ Данные не дублируются - один справочник на 3 языка  
✅ Обратная совместимость со старыми заказами  
✅ Легко добавить новые языки в будущем  

## Тестирование

1. Создайте механика с языком иврит
2. Зайдите под механиком и создайте заказ
3. Убедитесь, что категории и запчасти на иврите
4. Зайдите в админ-панель
5. Проверьте, что тот же заказ отображается на русском

## Миграция существующих данных

Если у вас есть старые заказы без `part_id`, они продолжат работать:
- Отобразятся с сохраненными названиями
- Перевод недоступен, но функциональность сохранена

Для полной поддержки перевода рекомендуется:
1. Убедиться, что все запчасти в базе имеют переводы
2. Новые заказы будут автоматически использовать новый формат
